!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(require("leaflet"),require("rbush")):"function"==typeof define&&define.amd?define(["leaflet","rbush"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).L,e.RBush)}(this,(function(e,t){"use strict";const s={_map:null,_canvas:null,_context:null,_markers:[],_markersTree:new t,_positionsTree:new t,_icons:{},addTo(e){return e.addLayer(this),this},getBounds(){const t=new e.LatLngBounds;return this._markers.forEach((e=>{t.extend(e.getLatLng())})),t},redraw(){this._redraw(!0)},clear(){this._positionsTree=new t,this._markersTree=new t,this._markers=[],this._redraw(!0)},addMarker(e,t=!0){const{markerBox:s,positionBox:i,isVisible:o}=this._addMarker(e,t);s&&o&&this._markersTree.insert(s),i&&this._positionsTree.insert(i)},addMarkers(e,t=!0){const s=[],i=[];e.forEach((e=>{const{markerBox:o,positionBox:a,isVisible:r}=this._addMarker(e,t);o&&r&&s.push(o),a&&i.push(a)})),this._markersTree.load(s),this._positionsTree.load(i)},removeMarker(e,t=!0){const s=e.getLatLng(),i=this._map.getBounds().contains(s),o={minX:s.lng,minY:s.lat,maxX:s.lng,maxY:s.lat,marker:e};this._positionsTree.remove(o,((e,t)=>e.marker._leaflet_id===t.marker._leaflet_id)),i&&t&&this._redraw(!0)},removeMarkers(e,t=!0){let s=!1;e.forEach((e=>{const i=e.getLatLng(),o=this._map.getBounds().contains(i),a={minX:i.lng,minY:i.lat,maxX:i.lng,maxY:i.lat,marker:e};this._positionsTree.remove(a,((e,t)=>e.marker._leaflet_id===t.marker._leaflet_id)),o&&t&&(s=!0)})),s&&this._redraw(!0)},initialize(t){e.Util.setOptions(this,t)},onAdd(e){this._map=e,this._initCanvas(),this.getPane().appendChild(this._canvas),e.on("moveend",this._reset,this),e.on("resize",this._reset,this),e.on("click",this._fire,this),e.on("mousemove",this._fire,this),e._zoomAnimated&&e.on("zoomanim",this._animateZoom,this)},onRemove(e){this.getPane().removeChild(this._canvas),e.off("click",this._fire,this),e.off("mousemove",this._fire,this),e.off("moveend",this._reset,this),e.off("resize",this._reset,this),e._zoomAnimated&&e.off("zoomanim",this._animateZoom,this)},setOptions(t){return e.Util.setOptions(this,t),this.redraw()},_initCanvas(){const{x:t,y:s}=this._map.getSize(),i=this._map.options.zoomAnimation&&e.Browser.any3d;this._canvas=e.DomUtil.create("canvas","leaflet-markers-canvas-layer leaflet-layer"),this._canvas.width=t,this._canvas.height=s,this._context=this._canvas.getContext("2d"),e.DomUtil.addClass(this._canvas,"leaflet-zoom-"+(i?"animated":"hide"))},_addMarker(t,s=!0){if("markerPane"!==t.options.pane||!t.options.icon)return console.error("This is not a marker",t),{markerBox:null,positionBox:null,isVisible:null};t._map=this._map,e.Util.stamp(t);const i=t.getLatLng(),o=this._map.getBounds().contains(i),{x:a,y:r}=this._map.latLngToContainerPoint(i),{iconSize:n,iconAnchor:m}=t.options.icon.options,h={minX:a-m[0],minY:r-m[1],maxX:a+n[0]-m[0],maxY:r+n[1]-m[1],marker:t},_={minX:i.lng,minY:i.lat,maxX:i.lng,maxY:i.lat,marker:t};return o&&s&&this._drawMarker(t,{x:a,y:r}),this._markers.push(t),{markerBox:h,positionBox:_,isVisible:o}},_drawMarker(e,{x:t,y:s}){const{iconUrl:i}=e.options.icon.options;if(e.image)this._drawImage(e,{x:t,y:s});else if(this._icons[i])e.image=this._icons[i].image,this._icons[i].isLoaded?this._drawImage(e,{x:t,y:s}):this._icons[i].elements.push({marker:e,x:t,y:s});else{const o=new Image;o.src=i,e.image=o,this._icons[i]={image:o,isLoaded:!1,elements:[{marker:e,x:t,y:s}]},o.onload=()=>{this._icons[i].isLoaded=!0,this._icons[i].elements.forEach((({marker:e,x:t,y:s})=>{this._drawImage(e,{x:t,y:s})}))}}},_drawImage(e,{x:t,y:s}){const{rotationAngle:i,iconAnchor:o,iconSize:a}=e.options.icon.options,r=i||0;this._context.save(),this._context.translate(t,s),this._context.rotate(r*Math.PI/180),this._context.drawImage(e.image,-o[0],-o[1],a[0],a[1]),this._context.restore()},_redraw(e){if(e&&this._context.clearRect(0,0,this._canvas.width,this._canvas.height),!this._map||!this._positionsTree)return;const t=this._map.getBounds(),s={minX:t.getWest(),minY:t.getSouth(),maxX:t.getEast(),maxY:t.getNorth()},i=[];this._positionsTree.search(s).forEach((({marker:e})=>{const t=e.getLatLng(),{x:s,y:o}=this._map.latLngToContainerPoint(t),{iconSize:a,iconAnchor:r}=e.options.icon.options,n={minX:s-r[0],minY:o-r[1],maxX:s+a[0]-r[0],maxY:o+a[1]-r[1],marker:e};i.push(n),this._drawMarker(e,{x:s,y:o})})),this._markersTree.clear(),this._markersTree.load(i)},_reset(){const t=this._map.containerPointToLayerPoint([0,0]);e.DomUtil.setPosition(this._canvas,t);const{x:s,y:i}=this._map.getSize();this._canvas.width=s,this._canvas.height=i,this._redraw()},_fire(e){if(!this._markersTree)return;const{x:t,y:s}=e.containerPoint,i=this._markersTree.search({minX:t,minY:s,maxX:t,maxY:s});if(i&&i.length){this._map._container.style.cursor="pointer";const t=i[0].marker;"click"===e.type&&t.listens("click")&&t.fire("click"),"mousemove"===e.type&&(this._mouseOverMarker&&this._mouseOverMarker!==t&&this._mouseOverMarker.listens("mouseout")&&this._mouseOverMarker.fire("mouseout"),this._mouseOverMarker&&this._mouseOverMarker===t||(this._mouseOverMarker=t,t.listens("mouseover")&&t.fire("mouseover")))}else this._map._container.style.cursor="","mousemove"===e.type&&this._mouseOverMarker&&(this._mouseOverMarker.listens("mouseout")&&this._mouseOverMarker.fire("mouseout"),delete this._mouseOverMarker)},_animateZoom(t){const s=this._map.getZoomScale(t.zoom),i=this._map._latLngBoundsToNewLayerBounds(this._map.getBounds(),t.zoom,t.center).min;e.DomUtil.setTransform(this._canvas,i,s)}};e.MarkersCanvas=e.Layer.extend(s)}));
